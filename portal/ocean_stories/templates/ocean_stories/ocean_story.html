{% extends "cms_base.html" %}
{% load wagtailcore_tags static%}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'bower_components/ol3-unofficial/ol.css' %}" />
{% endblock %}


{% block header %}
  <div class="sticky-header">
    {{ block.super }}
    <div id="map"></div>
  </div>
{% endblock %}

{% block content %}
  {% if self.sections %}
    <div class="sections">
        {% for section in self.sections.all %}
            <div class="section">
                <h2>{{ section.title }}</h2>
                {% if section.body %}
                  {{ section.body|richtext }}
                {% endif %}
            </div>
        {% endfor %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script src="{% static 'bower_components/ol3-unofficial/ol.js' %}"></script>
	<script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>
  <script src="{% static 'portal/ocean_story.js' %}"></script>
  <script src="{% static 'portal/ocean_stories/ol3_map_engine.js' %}"></script>
  <script src="{% static 'portal/ocean_stories/hacky_marine_cadastre_layer_conversion.js' %}"></script>
  <script src="{% static 'portal/ocean_stories/scroll_spy.js' %}"></script>

    <script type="text/javascript">
    var story = {{ self.as_json|safe }};

    var storyMap;
    $.getJSON("/data_manager/api/layers", function(data) {

      var dataLayers = _.indexBy(data, 'id');
      _.each(dataLayers, function(d) {
        if (d.layer_type == 'ArcRest') {
          hackyMarineCadastreLayerConversion(d);
        }
      })
      oceanStoryMap = new OceanStoryMap(ol3MapEngine('map'), story, dataLayers);

      scrollSpy('.content', '> .container > .sections > .section', function(sectionIndex){
        return oceanStoryMap.goToSection(sectionIndex);
      })
    });
  </script>
{% endblock %}
